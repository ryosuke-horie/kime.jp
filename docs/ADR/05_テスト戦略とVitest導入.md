# ADR 05: テスト戦略とVitest導入

## ステータス

提案 (2025-05-03)

## 背景

Kimeプロジェクトの品質向上と開発効率化のため、テスト自動化の導入が必要となっています。特に、Cloudflare Workers上で動作するバックエンドAPIのテスト方法について検討が必要です。TDD（テスト駆動開発）アプローチの採用も視野に入れた効率的なテスト戦略を策定します。

## 決定事項

1. テストランナーとしてVitestを採用する
2. Cloudflare Workers向けのテストにCloudflare公式テストツール（@cloudflare/vitest-pool-workers）を使用する
3. モノレポ構造に適したテスト設定を導入する
4. Hono APIエンドポイントのテスト手法を標準化する
5. Durable Objectsのモック方法を確立する

## 理由

- Vitestは高速な実行速度と良好なDX（開発者体験）を提供する
- VitestはJest互換APIを持ちながらViteの高速ビルド機構を活用できる
- Cloudflare公式テストツールはWorker環境を再現し、バインディングやDurable Objectsなどの複雑なCloudflare機能のテストをサポートする
- モノレポアプローチにより、共通設定を活用しつつプロジェクト固有の要件に対応できる
- HonoのAPIエンドポイントテストは単体テストと統合テストの両方をサポートする必要がある

## 詳細

### テスト戦略の概要

1. **ユニットテスト**:
   - ビジネスロジック、ユーティリティ関数の個別テスト
   - 外部依存はモック化

2. **統合テスト**:
   - APIエンドポイントの機能テスト（Hono + Durable Objects）
   - エンドツーエンドのリクエスト/レスポンスの検証

3. **テスト環境**:
   - ローカル開発環境でのテスト実行
   - CI/CDパイプラインでの自動テスト

### 技術選定

1. **Vitest**: 
   - Viteベースの高速なテストランナー
   - HMR対応のウォッチモード
   - Jest互換API

2. **@cloudflare/vitest-pool-workers**:
   - Cloudflare公式テストプール
   - Workers環境の完全再現
   - DO（Durable Objects）サポート

3. **モック戦略**:
   - Vitestのモック/スパイ機能
   - Cloudflare環境のモック手法
   - 外部APIのモック

## 代替案

1. **Jest**: 
   - 広く使われているテストランナーだが、Viteプロジェクトとの統合が難しい
   - モノレポ設定が複雑になる可能性がある

2. **Miniflare単独使用**:
   - Cloudflare Workers環境のエミュレーションツール
   - テストランナーが別途必要

3. **カスタムテスト環境構築**:
   - 開発工数が大きく、メンテナンスコストが高い

## 依存関係

- Turborepoパイプライン設定
- Cloudflare Workersデプロイフロー
- CI/CD設定

## 結果

- 品質の向上（バグの早期発見）
- 開発速度の向上（特にTDDアプローチ採用時）
- コード信頼性の向上
- リファクタリングの安全性確保
- ドキュメントとしてのテスト（機能理解の促進）