# 要件定義書 — 格闘技ジム向けAI予約・フォローアップシステム

---

## 目次
1. システム概要
2. 機能詳細要件
   1. 予約管理
   2. 通知オーケストレーション
   3. AI チャット／FAQ
   4. AI フォローアップ生成
   5. 管理ダッシュボード
   6. セキュリティ／認証
3. 非機能要件（参考）
4. KPI・計測指標（参考）

---

## 1. システム概要
### 1.1 目的
- 格闘技ジムにおける「体験予約 → リマインド → 体験後フォロー」を自動化し、来店率と入会率を向上させる。
- 少人数スタッフでも運用可能な **省力化フロー** を構築し、迅速な検証（MVP）を行う。

### 1.2 対象ユーザー
| 区分 | 役割 |
|------|------|
| ビジター | 体験予約を行う潜在顧客 |
| 会員候補 | 体験クラスを受講済みで入会検討中の顧客 |
| スタッフ | ジム運営者（オーナー／トレーナー） |
| 管理者    | KPI 監視や手動介入を行う利用者 |

### 1.3 全体構成（Cloudflare エコシステム）
- **Next.js (Pages & Functions)** : フロント UI（LP／予約フォーム／Thanks）
- **Cloudflare Workers (Hono)** : API 層
- **D1** : 予約・顧客データ格納 (SQLite)
- **Queues + Durable Objects** : 通知ジョブ管理（即時／遅延）
- **Workers AI** : FAQ 応答・フォローアップ文生成
- **Vectorize** (任意) : FAQ ベクトル検索
- **Cloudflare Access** : /admin 認証
- **Turnstile** : Bot 予約防止

---

## 2. 機能詳細要件

### 2.1 予約管理
| No | 要件ID | 概要 | 詳細 |
|----|--------|------|------|
| 1 | RES-01 | 空き枠取得 API | `/api/slots` GET で JSON を返す。パラメータ：日付範囲、プラン種別。|
| 2 | RES-02 | 予約登録 API | `/api/book` POST。入力: 氏名・メール・電話・希望枠 ID。成功時に予約 ID を返却し Queue へイベント送信。|
| 3 | RES-03 | 予約ステータス | `pending / confirmed / cancelled / attended / joined` を持つ。|
| 4 | RES-04 | Thanks ページ | 予約完了後にリダイレクトし、ICS ファイル＋LINE 友だち導線を表示。|

### 2.2 通知オーケストレーション
| No | 要件ID | トリガー | チャネル | 内容 |
|----|--------|---------|---------|------|
| 1 | NOT-01 | 予約確定 | LINE, SMS(フォールバック) | 確定メッセージ＋予約詳細＋キャンセルリンク |
| 2 | NOT-02 | 前日 18:00 JST | LINE, SMS | リマインダー（持ち物, 住所, 地図）|
| 3 | NOT-03 | 無断キャンセル検知 | LINE | 再予約リンクと質問受付 |
| 4 | NOT-04 | 体験後 24h | LINE, メール | アンケート＋特典案内 (AI 生成) |
| 5 | NOT-05 | 体験後 7d | LINE, AI Voice(任意) | 入会特典再案内 |

### 2.3 AI チャット／FAQ
- **LIFF** で起動するチャットボット。
- Llama‑3 8B instruct を使用。
- Prompt に "役割: 格闘技ジムスタッフ" を固定。
- FAQ データソース: CSV から Vectorize へ投入 (オプション)。

### 2.4 AI フォローアップ生成
- 入力: `顧客名, レッスン内容, 特典情報`。
- 出力: 250 文字以内メッセージ（日本語）。
- トーン: 親しみやすく・行動を促す CTA 付き。

### 2.5 管理ダッシュボード
| No | 要件ID | 画面 / API | 説明 |
|----|--------|------------|------|
| 1 | ADM-01 | 予約一覧 | 日付範囲・ステータスで検索、CSV ダウンロード可 |
| 2 | ADM-02 | 送信ログ | LINE / SMS / Email / Voice の配信結果を表示 |
| 3 | ADM-03 | チェックイン | 予約詳細画面に「来店済み」ボタン |

### 2.6 セキュリティ／認証
- `/admin/*` は Cloudflare Access の JWT Claim に `role=admin` を要求。
- API は `Origin` チェック＋ Turnstile トークン検証。
- 個人情報は D1 内で **暗号化列** (SQLite crypto) に保存（電話番号・メール）。

---

## 3. 非機能要件（抜粋）
| 区分 | 指標 | 目標値 |
|------|------|--------|
| 可用性 | API 成功率 | 99.9 % / 月 |
| 性能 | 予約 API P95 | ≤ 300 ms |
| 拡張性 | 通知チャネル追加 | コード変更 50 行以内 |
| 運用 | ログ保管 | 90 日 (R2) |
| セキュリティ | PenTest | 初回リリース前に実施 |

---

## 4. KPI・計測指標（MVP 検証）
| 指標 | 公式 | 目標 (3 か月) |
|------|------|--------------|
| 予約完了率 | 予約数 ÷ LP UU | 5 % |
| 来店率 | 来店 ÷ 予約 | 70 % |
| 入会率 | 入会 ÷ 来店 | 30 % |

---

## 5. 開発着手手順（機能依存を考慮した推奨順）
以下は MVP を 2〜3 週間で検証可能にするための実装順序です。

| フェーズ | 着手順 | 主要タスク | 依存・目的 |
|----------|--------|------------|-------------|
| **環境準備** | 1 | リポジトリ作成（monorepo）／Wrangler 初期化／CI (CF Pages) | ― |
|  | 2 | D1 スキーマ定義 & マイグレーション Seed | データモデル確定 |
| **予約基盤** | 3 | `/api/slots` GET 実装（固定スロット） | DB |
|  | 4 | `/api/book` POST + Turnstile | API, D1 |
|  | 5 | Next.js `reserve` ページ (Wizard UI) | API 完成 |
| **通知基盤** | 6 | Cloudflare Queues + Durable Objects セットアップ | 予約イベント後処理 |
|  | 7 | LINE OA Webhook & Push メッセージ送信 | Queue |
|  | 8 | SMS (Twilio) Fallback Driver | Queue, LINE |
| **体験後フロー** | 9 | Workers AI 呼び出しラッパー（Follow‑up 文生成） | Queue |
|  | 10 | 24h / 7d ジョブの遅延送信実装 | DO Timer |
| **管理 UI** | 11 | `/admin` 予約一覧 & CSV DL | API, Access |
|  | 12 | 来店チェックイン機能 | Reservation Status |
| **チャット & FAQ** | 13 | LIFF チャット UI + Workers AI FAQ | LINE OA |
|  | 14 | Vectorize FAQ (任意) | チャット |
| **リリース準備** | 15 | Cloudflare Access ルール／Turnstile Production | セキュリティ |
|  | 16 | KPI ログ計測（Analytics + Logs） | 全体 |

> **スプリント推奨**
> - **Sprint‑0 (環境準備)**：手順 1–2
> - **Sprint‑1 (予約基盤)**：手順 3–5
> - **Sprint‑2 (通知基盤)**：手順 6–8
> - **Sprint‑3 (フォロー & 管理)**：手順 9–12
> - **Sprint‑4 (AI FAQ & Hardening)**：手順 13–16

---

*本資料は MVP フェーズの要件定義であり、今後の検証結果に応じて改訂される可能性があります。*
