# ジムアカウント発行機能要件定義

## 1. 機能概要

管理者が新規ジム用アカウントを発行できる機能を実装します。この機能により、サービス管理者はシステムに新規ジムを登録し、そのジムのオーナーアカウントを作成することができます。

## 2. 目的と背景

- ジム施設の新規顧客獲得時に、管理者がシステム上で新規ジムアカウントを発行できるようにする
- 初期設定はメールアドレスとパスワードで行い、後からGoogle/LINE認証を追加できるようにする
- ジム登録時に基本情報と管理者情報を一度に設定できるようにする

## 3. アクセス制限

- この機能は管理者（サービス管理者）のみがアクセス可能
- 将来的にはCloudflare Accessによる認証を導入し、特定の管理者のみがアクセスできるよう制限する予定

## 4. 機能要件

### 4.1 バックエンド機能

#### 4.1.1 ジム登録・アカウント発行API

- エンドポイント: `/api/gyms/create`
- メソッド: POST
- 認証: 管理者（adminロール）のみアクセス可能
- リクエストパラメータ:
  ```typescript
  {
    // ジム情報
    name: string;              // ジム名（必須）
    phoneNumber: string;       // 電話番号（必須）
    
    // オーナー情報
    ownerEmail: string;        // オーナーのメールアドレス（必須）
    password: string;          // 初期パスワード（必須、8文字以上）
    ownerName: string;         // オーナー名（必須）
  }
  ```
- レスポンス:
  ```typescript
  {
    message: string;           // 処理結果メッセージ
    gymId: string;             // 作成されたジムのID
    ownerId: string;           // 作成されたオーナーのID
  }
  ```

#### 4.1.2 処理内容

1. ジムレコードの作成
   - ジム基本情報（名前、電話番号、タイムゾーン、プラン）の登録
   - ユニークIDの発行と登録日時の記録

2. ジムオーナーアカウントの作成
   - アカウント基本情報（メール、名前、パスワード）の登録
   - パスワードのハッシュ化と安全な保存
   - アカウントとジムの関連付け（owner権限の付与）

3. 成功時の通知
   - フロントエンドに成功メッセージと作成されたIDを返却
   - 将来的には確認メールの送信機能も追加予定（別Issue）

### 4.2 フロントエンド機能

#### 4.2.1 ジムアカウント発行ページ

- 場所: 管理者ダッシュボード内に新規タブとして追加
- URL: `/staff/create`
- アクセス制限: 管理者（adminロール）のみアクセス可能

#### 4.2.2 UI要素

- ジム情報入力セクション
  - ジム名入力フィールド（必須）
  - 電話番号入力フィールド（必須）

- オーナー情報入力セクション
  - メールアドレス入力フィールド（必須）
  - オーナー名入力フィールド（必須）
  - パスワード入力フィールド（必須）
  - パスワード確認入力フィールド（必須）

- アクション
  - 送信ボタン
  - キャンセルボタン（ダッシュボードに戻る）

#### 4.2.3 バリデーション

- ジム名: 1〜100文字
- 電話番号: 有効な電話番号形式
- メールアドレス: 有効なメール形式
- パスワード: 8文字以上
- パスワード確認: パスワードと一致

#### 4.2.4 UI/UXフロー

1. 管理者がダッシュボードから「ジムアカウント発行」ボタンをクリック
2. ジムアカウント発行フォームページに遷移
3. 必要情報を入力
4. 送信ボタンをクリック
5. 送信中はローディング表示
6. 成功時は成功メッセージを表示し、詳細情報（ID等）を表示
7. エラー時はエラーメッセージを表示

## 5. データモデル変更

### 5.1 既存テーブル拡張

- `gyms`テーブルに`phoneNumber`フィールドを追加
  ```sql
  ALTER TABLE gyms ADD COLUMN phone_number TEXT NOT NULL;
  ```

### 5.2 関連テーブル

- 既存の`adminGymRelationships`テーブルを使用してオーナー関連付けを行う
- 既存の`adminAccounts`テーブルを使用してオーナーアカウントを作成

## 6. セキュリティ考慮事項

- パスワードは適切なハッシュ化アルゴリズムを使用して保存
- APIエンドポイントは管理者認証を必須とする
- フォーム送信はCSRF対策を施す

## 7. 将来拡張予定

- アカウント発行後の自動メール通知機能
- Google/LINE認証の追加設定機能（別Issue）
- ジム申し込みページの作成（別Issue）

## 8. 技術的実装メモ

- Next.jsのApp Routerを使用したページ実装
- フォームバリデーションはZodを使用
- APIエンドポイントはHonoフレームワークで実装
- データベース操作はDrizzle ORMとCloudflare DOを使用