# 外部認証プロバイダ設定ガイド

このガイドでは、kime.jpアプリケーションで使用している外部認証プロバイダ（Google、LINE）の開発環境での設定手順を説明します。認証機能をローカル環境でテストするための必要な手順を順を追って解説します。

## 目次

1. [環境変数の設定](#環境変数の設定)
2. [Google認証の設定](#google認証の設定)
3. [LINE認証の設定](#line認証の設定)
4. [開発環境でのテスト方法](#開発環境でのテスト方法)
5. [トラブルシューティング](#トラブルシューティング)

## 環境変数の設定

外部認証を機能させるためには、必要な環境変数を設定する必要があります。以下の手順に従って設定してください。

1. プロジェクトのルートディレクトリにある `/apps/web/.env.local.example` ファイルをコピーして `.env.local` を作成します。

```bash
cp /apps/web/.env.local.example /apps/web/.env.local
```

2. `.env.local` ファイルを編集し、以下の項目を適切な値に設定します：

```
# NextAuth Base URL
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=自分で設定した安全なランダム文字列

# Google OAuth
GOOGLE_CLIENT_ID=Googleから取得したクライアントID
GOOGLE_CLIENT_SECRET=Googleから取得したクライアントシークレット

# LINE OAuth
LINE_CLIENT_ID=LINEから取得したクライアントID
LINE_CLIENT_SECRET=LINEから取得したクライアントシークレット

# Admin credentials (for development only)
ADMIN_EMAIL=開発用の管理者メールアドレス
ADMIN_PASSWORD=開発用の管理者パスワード
```

**注意**: `.env.local` ファイルはリポジトリにコミットしないでください。このファイルは `.gitignore` に含まれており、開発者ごとに個別に設定する必要があります。

## Google認証の設定

GoogleのOAuth認証を設定するには、GoogleクラウドコンソールでプロジェクトとOAuthクライアントIDを作成する必要があります。

### 1. Googleクラウドプロジェクトの作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセスし、Googleアカウントでログインします。
2. 画面右上のプロジェクト選択ドロップダウンから「新しいプロジェクト」を選択します。
3. プロジェクト名（例：`kime-development`）を入力し、「作成」をクリックします。

### 2. OAuth同意画面の設定

1. 左側のメニューから「APIとサービス」→「OAuth同意画面」を選択します。
2. ユーザータイプとして「外部」を選択し、「作成」をクリックします。
3. 以下の情報を入力します：
   - アプリ名：`KIME Development`
   - ユーザーサポートメール：あなたのメールアドレス
   - デベロッパーの連絡先情報：あなたのメールアドレス
4. 「保存して次へ」をクリックします。
5. スコープの追加画面では、何も追加せずに「保存して次へ」をクリックします。
6. テストユーザーの追加画面で、自分のメールアドレスを追加し、「保存して次へ」をクリックします。
7. 概要を確認し、「ダッシュボードに戻る」をクリックします。

### 3. OAuth認証情報の作成

1. 左側のメニューから「APIとサービス」→「認証情報」を選択します。
2. 「認証情報を作成」ボタンをクリックし、「OAuthクライアントID」を選択します。
3. アプリケーションの種類として「ウェブアプリケーション」を選択します。
4. 名前を入力します（例：`KIME Web Client`）。
5. 「承認済みのリダイレクトURI」に以下のURLを追加します：
   - `http://localhost:3000/api/auth/callback/google`
6. 「作成」ボタンをクリックします。
7. 表示されたクライアントIDとクライアントシークレットをコピーし、`.env.local`ファイルの`GOOGLE_CLIENT_ID`と`GOOGLE_CLIENT_SECRET`に設定します。

## LINE認証の設定

LINE認証を設定するには、LINE Developersコンソールでチャネルを作成する必要があります。

### 1. LINEログインチャネルの作成

1. [LINE Developers Console](https://developers.line.biz/console/)にアクセスし、LINEアカウントでログインします。
2. プロバイダーを選択するか、新しいプロバイダーを作成します。
3. 「新規チャネル作成」ボタンをクリックします。
4. 「LINEログイン」を選択します。
5. 以下の情報を入力します：
   - チャネル名：`KIME Development`
   - チャネル説明：`KIME開発環境用のLINEログイン`
   - アプリタイプ：「WEBアプリ」を選択
   - メールアドレス：あなたのメールアドレス
6. 「利用規約」と「LINE開発者契約」に同意し、「作成」ボタンをクリックします。

### 2. チャネル基本設定の構成

1. 作成したチャネルの「チャネル基本設定」タブを開きます。
2. 以下の情報を確認・設定します：
   - チャネルID：`.env.local`ファイルの`LINE_CLIENT_ID`に設定します。
   - チャネルシークレット：`.env.local`ファイルの`LINE_CLIENT_SECRET`に設定します。

### 3. コールバックURLの設定

1. 「App settings」タブを開きます。
2. 「Callback URL」セクションで「追加」ボタンをクリックし、以下のURLを追加します：
   - `http://localhost:3000/api/auth/callback/line`
3. 「更新」ボタンをクリックして設定を保存します。

## 開発環境でのテスト方法

環境変数とOAuth設定が完了したら、Next.jsアプリケーションを起動してログイン機能をテストできます。

### 1. アプリケーションの起動

```bash
pnpm --filter=web dev
```

### 2. ログイン機能のテスト

1. ブラウザで `http://localhost:3000/auth/signin` にアクセスします。
2. ログイン画面が表示されます。以下の方法でログインをテストできます：
   - **メールログイン**: `.env.local`で設定した`ADMIN_EMAIL`と`ADMIN_PASSWORD`を使用
   - **Googleログイン**: 「Googleでログイン」ボタンをクリックし、認証フローを完了
   - **LINEログイン**: 「LINEでログイン」ボタンをクリックし、認証フローを完了

### 3. セッションの検証

ログイン後、以下の方法でセッションが正しく設定されていることを確認できます：

1. ブラウザのコンソールで以下のコードを実行します：
```javascript
const session = await fetch('/api/auth/session').then(res => res.json());
console.log(session);
```

2. 返されたJSONオブジェクトに、ユーザー情報（name, email, role）が含まれていることを確認します。

## トラブルシューティング

### 認証エラーが発生する場合

1. `.env.local`ファイルの設定を確認します：
   - 環境変数名が正確に設定されているか
   - クライアントIDとシークレットが正しく設定されているか

2. リダイレクトURLが正しく設定されているか確認します：
   - Google: `http://localhost:3000/api/auth/callback/google`
   - LINE: `http://localhost:3000/api/auth/callback/line`

3. ブラウザのDevToolsで、Networkタブを開き認証リクエストをモニタリングします。エラーレスポンスの詳細を確認することで、問題の特定に役立ちます。

### OAuthプロバイダーが開発モードの場合

Google OAuthが開発モード（テストユーザーのみアクセス可能）に設定されている場合：

1. テストユーザーリストに自分のメールアドレスが追加されていることを確認します。
2. チームメンバーが認証をテストする必要がある場合は、そのメールアドレスもテストユーザーとして追加します。

### LINE認証でエラーが発生する場合

1. LINEログインチャネルが「非公開」になっていることを確認します（開発環境では推奨）。
2. チャネル基本設定でWebログインが有効になっていることを確認します。

---

**注意**: このドキュメントは開発環境での設定のみをカバーしています。本番環境では異なる設定が必要な場合があります。本番環境への移行時には、セキュリティ要件を再評価し、機密情報の保護に十分注意してください。